name: Build RSDK

on: [ push, pull_request, workflow_dispatch ]

jobs:
  Build_ps3:
    runs-on: ubuntu-22.04
    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure environment
      run: |
        echo "PS3DEV=/usr/local/ps3dev" >> $GITHUB_ENV
        echo "PSL1GHT=/usr/local/ps3dev" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/usr/local/ps3dev/portlibs/ppu/lib/pkgconfig" >> $GITHUB_ENV
        echo "sha_name=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_ENV

    - name: Download PSL1GHT Toolchain
      run: |
        curl -sL https://github.com/StrawFox64/StrawFox64.github.io/releases/download/ps3dev-GCC7.5.0-ubuntu/ps3dev.tar.gz | sudo tar xvz -C /usr/local
  
    - name: Download dependencies (RSDK)
      run: |
        git clone https://github.com/nothings/stb.git
        git clone https://github.com/leethomason/tinyxml2.git
        git clone https://github.com/StrawFox64/Sonic-Mania-Decompilation.git
        
    - name: Move dependencies (RSDK)
      run: |
        cd Sonic-Mania-Decompilation
        mv SonicMania ../RSDKv5 && cd ..
        mv tinyxml2/* dependencies/all/tinyxml2
        mv stb/* dependencies/all/stb_vorbis
        
    - name: Build self
      run: |
        cd RSDKv5.ps3 && make && mv RSDKv5.self EBOOT.BIN

    - name: Generate Release Info
      id: release_info
      run: |
        TAG=$(git describe --abbrev=0 --tags)
        COMMITS=$(git log --oneline $(git describe --abbrev=0 --tags)..HEAD)
        RELEASE_NAME="Release $TAG"
        BODY="Release notes for $TAG\n\n$COMMITS"
        echo "::set-output name=tag::$TAG"
        echo "::set-output name=release_name::$RELEASE_NAME"
        echo "::set-output name=body::$BODY"
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_info.outputs.tag }}
        release_name: ${{ steps.release_info.outputs.release_name }}
        body: ${{ steps.release_info.outputs.body }}

    - name: Upload Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: RSDKv5.ps3/EBOOT.BIN
        asset_name: EBOOT.BIN
        asset_content_type: application/zip
